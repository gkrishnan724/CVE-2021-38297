<!DOCTYPE html>
<html>

<head>
    <title>Go WebAssembly Example</title>
    <script src="wasm_exec.js"></script>
</head>

<body>
    <script>
        let isWasmInit = false;
        let goExp;

        function convertHexToAscii(hexString) {
                // Remove the leading \x and split the string by \x
                const hexArray = hexString.replace(/\\x/g, '').match(/.{1,2}/g);
                
                // Convert each pair of hex digits to its ASCII equivalent
                const asciiString = hexArray.map(hex => String.fromCharCode(parseInt(hex, 16))).join('');
            
                return asciiString;
        }

        const initializeWASM = function() {

            console.log("WASM INITIALIZED!");

            const someInput = document.getElementById('argv').value;
            const go = new Go();
            WebAssembly.instantiateStreaming(fetch('main.wasm'), go.importObject).then((result) => {
                go.argv = ['main.wasm',someInput]; //Pass argv

                //Set a critical global variable at particular location
                let memory = result.instance.exports.mem.buffer;
                let encoder = new TextEncoder('utf-8')
                new Uint8Array(memory, 0x5000, 100).set(encoder.encode("ABCD"+"\0"));
                go.run(result.instance);
                console.log(result.instance.exports);
                goExp = result.instance.exports;
            });

            isWasmInit = true;
        }
        

        function addNumbers() {

            if (!isWasmInit) {
                console.log("WASM not initialized!!! Init WASM first");
                return;
            }
            const num1 = document.getElementById('num1').value;
            const num2 = document.getElementById('num2').value;

            const result = add(parseFloat(num1), parseFloat(num2));
            document.getElementById('result').innerText = `Result: ${result}`;
        }
    </script>

    <label for="argv">Argv:</label>
    <input type="text" id="argv"><br>
    <button onclick = "initializeWASM()">Initialize WASM!</button><br>

    <label for="num1">Number 1:</label>
    <input type="number" id="num1"><br>

    <label for="num2">Number 2:</label>
    <input type="number" id="num2"><br>

    <button onclick="addNumbers()">Add Numbers</button><br>
    <button onclick="printGlobal()">Print Global val</button>
    <button onclick="printSecret()">Print Secret</button>

    <div id="result"></div>
</body>

</html>
