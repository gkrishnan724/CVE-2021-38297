let postId = 0;
let user;

window.addEventListener('load', initialize);

const handleError =  function (err) {
  console.warn(err);
  alert("Some Error occured!");
  return;
}


async function initialize() {
  user = getSession()
  const postForm = document.getElementById('post-form');
  const signOutButton = document.getElementById('signout');
  const currentUserElm = document.getElementById('currentUsername');
  if (!user) {
    //Hide the form if no user
    postForm.style.display = 'none';
    currentUserElm.textContent = '';
    signOutButton.textContent = "Log in";
  } else {
    currentUserElm.textContent = user;
    signOutButton.textContent = "Sign out";
  }

  

  const result = await fetch('/api/feed').catch(handleError);
  const resultJson =  await result.json();
  if (!resultJson.posts) {
    alert("Some error occured in request");
    return;
  }

  renderPosts(resultJson.posts);
}


function getPostHTML(post) {
    let html =  `
        <p><strong>${post.post_author}</strong>: ${post.post_content}</p>
        <br/>
        <br/>
        <br/>
         -------------------------------------------------------
        `
        +
       `     
        <div class="comments" id="comments_${postId}">
      `;

      html += `<div>`;
      post.comments.forEach(function(comm) {
        html += getCommentHTML(comm.comment_author, comm.comment_content)
      });
      html += "</div>";
    if (user) {
      html += getCommentForm(post.id);
    }
    return html;
}
      
      

function getCommentForm(postId) {
  return `<div class="comment-form">
  <textarea id="commentText_${postId}" placeholder="Add a comment"></textarea>
  <button onclick="addComment(${postId})">Comment</button>
  </div>`
}

function getCommentHTML(commentUsername, commentText) {
  return `<p><strong>${commentUsername}</strong>: ${commentText}</p>`
}

function createPost() {
  const username = user;
  const postText = document.getElementById('postText').value.trim();
  
}


function renderPosts(postsList) {
  postsList.forEach(function(post) {
    const postContainer = document.getElementById('posts');
    const postElement = document.createElement('div');
    postElement.className = 'post';
    postElement.innerHTML = getPostHTML(post);
    postContainer.prepend(postElement);
  });  
}

function renderComments(postObj) {
  postObj.comments.forEach(function(comm) {
    const commentContainer = document.getElementById(`comments_${postId}`);
    const commentElement = document.createElement('div');
    commentElement.innerHTML = getCommentHTML(comm.comm_author, comm.comment_content);
    commentContainer.appendChild(commentElement);
  });
}
  
async function addComment(postId) {
  const commentUsername = user;
  const commentText = document.getElementById(`commentText_${postId}`).value.trim();
  //Network call to store comment in DB

  await fetch('/api/comment', {
      method: 'POST',
      headers: {
      'Accept': 'application/json',
      'Content-Type': 'application/json'
      },
    body: JSON.stringify({user: commentUsername, post_id: postId, comment_content: commentText})
  }).catch(handleError);

  location.reload();
}

async function createPost() {
  const username = user;
  const postText = document.getElementById('postText').value.trim();
  //Network call to create post in DB and refresh
  await fetch('/api/post', {
    method: 'POST',
    headers: {
    'Accept': 'application/json',
    'Content-Type': 'application/json'
    },
    body: JSON.stringify({user: username,  post_content: postText})
  }).catch(handleError);

  location.reload();
}

  
function signOut() {
  //Redirect to signOut
  destorySession();
  window.location.href = '/public';
}
